<% layout('layouts/boilerplateSecondary') %>


<div class="row">
    <div class="d-flex justify-content-between">

<!-- MAIN HEADER   -->
        <div <% if (literature.genre==='Poem' || literature.genre==='Poem (Youth)' || literature.genre==='Quote' || literature.genre==='Poem (Haiku)') {%>
                class="col-10 offset-1 col-md-8 offset-md-0 text-center mb-5"> 
            <%}else if (literature.genre==='Writing Prompt'){%> 
                class="col-12 col-md-9 offset-md-0  mb-5">
            <%} else {%> 
                class="col-12 col-md-9 offset-md-0 mb-5">
            <%}%>
            <div class="card text-dark bg-light">
                <div class="card-header d-inline d-flex justify-content-between">
                    <h6 class="text-muted my-2" style="visibility: hidden;"><%= literature.genre%></h6>
                    <h5 class="card-title"><%= literature.title%> <% if (literature.part!==1) { %>(#<%=literature.part %>)<%}%></h5>
                    <h6 class="text-muted my-2"><%= literature.genre%></h6>                    
                </div>
                
<!-- IMAGE ON SMALL SCREENS + BODY -->
                <% if(literature.image) {%> 
                <div style="background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('<%=literature.image.url %>') no-repeat center center; background-size:cover;" 
                    class="card-body card-background" data-bs-toggle="tooltip" data-bs-placement="top" title="Image by: <%=literature.imageCredit %>">
                <% }else { %> 
                <div style="background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('https://res.cloudinary.com/dkhmagpta/image/upload/v1609849755/sample.jpg %>') no-repeat center center; background-size:cover;" 
                    class="card-body card-background" data-bs-toggle="tooltip" data-bs-placement="top" title="Original image currently unavailable.">
                <% } %> 
                    <p class="card-text p-4 card-body-background" style="white-space: pre-wrap; background-color: #F5F4EEA1;"><%-literature.body%></p>
                </div>

<!-- NOTES|TAGS|DATES -->
                <div class="card-body d-flex justify-content-center text-center">
                    <ul style="width: 50vw;" class="list-group list-group-flush <% if (literature.genre==='Poem' || literature.genre==='Poem (Youth)' || literature.genre==='Quote' || literature.genre==='Poem (Haiku)') {%>text-center <%}%> mt-4">
                        <% if (literature.quoteBy!=='') { %>
                        <li class="list-group-item text-muted bg-light"><small><b>Quote By: </b><%= literature.quoteBy%> </li></small>
                        <% } %> 
                        <% if (literature.notes!=='') { %>
                        <li class="list-group-item text-muted bg-light"><small><b>Author's Note: </b><%= literature.notes%> </li></small>
                        <%}%>
                        <li class="list-group-item text-muted bg-light">
                            <small><b>Tags:</b></small>
                            <% for (i in literature.tags) {%> 
                                <a href="/literature/tags/<%=literature.tags[i]%> " class="btn btn-outline-secondary btn-sm py-0"> <%= literature.tags[i]%> </a> 
                            <% } %> 
                        </li>
                        <li class="list-group-item text-muted bg-light"><small><b>Created:</b> <%= literature.createdAt.toLocaleDateString()%></small>
                        </li>
                        <% if (literature.createdAt.toDateString() !== literature.updatedAt.toDateString()) {%> 
                        <li class="list-group-item text-muted bg-light"><small><b>Last updated:</b><%= literature.updatedAt.toLocaleDateString()%></small>
                        </li>
                        <% } %> 
                    </ul>
                </div>

<!-- EDIT|DELETE|ADD PART BUTTONS -->
                <% if(currentUser && currentUser.username==process.env.ADMIN ) { %>
                <div class="card-body d-flex justify-content-between">
                    <a class="card-link btn btn-secondary" href="/literature/<%=literature._id%>/edit">Edit</a>
                    <form class="d-inline" action="/literature/<%=literature._id%>?_method=DELETE" method="POST">
                        <button class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this post?');">Delete</button>
                    </form>
                    <% if(literature.next_id =='') {%> 
                    <a class="card-link btn btn-secondary" href="/literature/new/<%=literature._id%>">Add Part <%= literature.part+1 %> </a>
                    <% } %> 
                </div>
                <%}%>
                <div class="card-footer d-flex justify-content-around text-muted text-center">
                    <% if(literature.previous_id !=='') {%> 
                        <a class="btn btn-link btn-sm" href="/literature/<%=literature.previous_id%>">Part <%= literature.part-1 %></a>
                    <% } %> 
                    <a class="btn btn-outline-secondary btn-sm" href="/literature">Main Page</a>
                    <% if(literature.next_id !=='') {%> 
                        <a class="btn btn-link btn-sm" href="/literature/<%=literature.next_id%>">Part <%= literature.part+1 %></a>
                    <% } %> 
                </div>
            </div>
<!-- LIKES -->
            <% if(currentUser) { %>
            <div class="d-block justify-content-center text-center">
                <% if(literature.likes.includes(`${currentUser.id}`)) { %> 
                    <button id="like-btn" class="btn btn-unlike pb-0" 
                        onclick="likeLiterature(<%=literature.likes.length%>, '<%=literature._id%>')"><i class="fas fa-heart"></i>
                    </button>
                <%} else { %>
                    <button id="like-btn" class="btn btn-like pb-0" 
                        onclick="likeLiterature(<%=literature.likes.length%>, '<%=literature._id%>')"><i class="far fa-heart"></i>
                    </button>
                <% } %>
                <br>
            </div>
            <% } %> 
            <div class="p-2 text-center"> Likes: <span id ="likes-count"><%=literature.likes.length%></span></div>
        </div>

<!-- IMAGE -->
        <div style="max-width: 24rem;" class="card d-none d-md-block  text-dark bg-light align-self-start  mx-3 mb-5
            <% if (literature.genre==='Poem' || literature.genre==='Poem (Youth)' || literature.genre==='Quote' || literature.genre==='Poem (Haiku)') {%>
            col-4 text-center" 
            <%} else {%> col-3" <%}%> >
            <div class="row">
                <div class="card-body">
                    <% if(literature.image) {%> 
                    <img src="<%=literature.image.url %> " alt="" class="img-fluid" data-bs-toggle="tooltip" data-bs-placement="top" title="<%=literature.imageCredit %> ">
                    <% } else { %> 
                    <img src="https://res.cloudinary.com/dkhmagpta/image/upload/v1609849755/sample.jpg" alt="" class="img-fluid" data-bs-toggle="tooltip" data-bs-placement="top" title="Original image currently unavailable.">
                    <% } %> 
                </div>
            </div>
        </div>

    </div>

<!-- LEAVE A COMMENT -->
    <div class="display-comments" >
        <div class="card-body border border-light rounded-3 col-10 offset-1 col-md-6 offset-md-0 mb-3 me-3" id="newComment">   
            <h2 class="mb-3 text-center">Leave a comment! <i class="far fa-comment-alt"></i></h2>
            <% if(currentUser && currentUser.status=="normal") { %>
            <form action="/literature/<%=literature._id%>/comments" method="POST" class="my-3 validated-form" novalidate>
                <div class="mb-3">
                    <textarea class="form-control" name="comment[body]" id="body" cols="30" rows="3" minlength="1" maxlength="500" required></textarea>
                </div>
                <button class="btn btn-success">Submit</button>
            </form>
            <%} else if(!currentUser){%>
            <div class="text-muted text-center mb-3">
                <a class="btn btn-outline-success btn-sm me-3" href="/login">Login</a>
                <a class="btn btn-outline-primary btn-sm me-3" href="/register">Register</a>
            </div>
            <%} else {%>
            <div class="text-center text-muted">This account had been banned.</div>
            <% } %> 
        </div>

<!-- ALL COMMENTS -->
        <div class="card-body border border-light rounded-3 col-10 offset-1 col-md-6 offset-md-0 mb-3" id="allComments">   
            <h2 class="mb-3 text-center">Comments <i class="fas fa-comment-alt"></i></h2>
            <% if (!literature.comments.length) {%>
                <h3 class="text-center pt-4">Be the first to comment!</h1>
            <% } %>  
            <% const perPage = 2 %> 
            <% for (let i=0; i<perPage; i++) {%>
                <% if ((perPage*(page-1)+i)<literature.comments.length)  {%> 
                    <% let comment = literature.comments[perPage*(page-1)+i] %> 
                    <div style="color:<%=comment.username.textColor%>" class="card mb-3 
                    <% if(comment.username.commentBoxTheme == 'light') {%> light-comment-box <% } else { %> dark-comment-box <% } %>" >
                        <div class="d-inline d-flex justify-content-between card-header <% if(comment.username.commentBoxTheme == 'light') {%> bg-light <% } else { %> bg-dark <% } %>">
                            <small class="card-title m-0 p-0"><%=comment.username.name%> (#<%=comment.username.uniqueNumber%>) </small>
                            <small><%=comment.createdAt.toLocaleDateString()%></small>
                        </div>
                        <p class="card-text mx-3 my-2 pb-3" style="white-space: pre-wrap"><%=comment.body%></p>
                        <div class="card-footer m-0 p-0 d-flex justify-content-between text-center">
                            <small class="p-2 <% if(comment.username.commentBoxTheme == 'light') {%> text-dark <% } else { %> text-light <% } %>">#<%=comment.number%></small>
                            <div class="d-flex flex-row-reverse">
                                <% if (currentUser && (comment.username.equals(currentUser._id) || currentUser.username==process.env.ADMIN)) {%>
                                    <% if (currentUser.username==process.env.ADMIN) {%>
                                    <form action="/<%= literature._id %>/user/<%=comment.username._id%>?_method=PUT" method="POST">
                                        <% if(comment.username.status=="normal") {%> 
                                        <button id="banUser" class="btn btn-sm m-1 btn-danger">Ban User</button>
                                        <% } else { %>
                                        <button id="banUser" class="btn btn-sm m-1 btn-success">Unban User</button>
                                        <% } %> 
                                    </form>
                                    <%}%>
                                <form action="/literature/<%=literature._id%>/comments/<%=comment._id%>?_method=DELETE" method="POST">
                                    <button class="btn btn-sm  m-1 <% if(comment.username.commentBoxTheme == 'light') {%> btn-dark <% } else { %> btn-light <% } %>" onclick="return confirm('Are you sure you want to delete this comment?');" >Delete</button>
                                </form>
                                <%}%>
                                <% if (currentUser) {%> 
                                <a onClick="replyTo('<%= comment.username.name %>', '<%=comment.number%>')" class="btn btn-sm px-2 m-1 <% if(comment.username.commentBoxTheme == 'light') {%> btn-outline-dark <% } else { %> btn-outline-light <% } %>" 
                                >Reply</a>
                                <% } %> 
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <% break; %>
                <% } %>
            <%}%>


        </div>

    </div>

<!-- PAGINATION -->
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            <li class="page-item <% if (page==1) {%> disabled <% } %>">
                <a class="page-link" href="/literature/<%= literature._id%>/<%= page-1 %>">Previous</a>
            </li>
            <% for (let i=1; i<=Math.ceil(literature.comments.length/perPage); i++) { %>
                <li class="page-item <% if (i==page) { %> active text-light bg-dark <% } %> ">
                    <a class="page-link" href="/literature/<%= literature._id%>/<%= i %>"><%= i  %></a>
                </li>
            <% } %>  
            <li class="page-item <% if (page==Math.ceil(literature.comments.length/perPage)) {%> disabled <% } %>">
                <a class="page-link" href="/literature/<%= literature._id%>/<%= parseInt(page, 10) + 1%>">Next</a>
            </li>
        </ul>
    </nav>
    
</div>


<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="/javascripts/likeLogic.js"></script>
<script src="/javascripts/replyTo.js"></script>